{% extends 'dashboard/app/base.html' %}
{% load staticfiles %}
{% load timetags %}
{% block content %}

    <div class="main-content">
        <!-- Top navbar -->
        {% include 'dashboard/app/top-navbar.html' %}
        <!-- Header -->
        <input id="view-tag" value="auth" hidden>
        <div class="header bg-gradient-primary pb-7 pt-5 pt-md-8">
            <div class="container-fluid">
                <div class="header-body">

                    <div class="alert alert-primary" role="alert">
                        <strong>AWS DynamoDB, AWS Lambda, AWS APIGateway</strong> {{ _("are used") }}
                    </div>

                    <!-- Card stats -->
                    <div class="row">
                        <div class="col-xl-6 col-lg-6">
                            <div class="card card-stats mb-4 mb-xl-0">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <h5 class="card-title text-uppercase text-muted mb-0">{{ _("Members") }}</h5>
                                            <span class="h2 font-weight-bold mb-0">{{ user_count.item.count }} </span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                                                <i class="fas fa-user-friends"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6">
                            <div class="card card-stats mb-4 mb-xl-0">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <h5 class="card-title text-uppercase text-muted mb-0">{{ _("Sessions") }}</h5>
                                            <span class="h2 font-weight-bold mb-0">{{ session_count.item.count }} </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page content -->
        <div class="container-fluid mt--7">
            <div class="row mt-4">
                <div class="col-xl-12 mb-5 mb-xl-0">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h3 class="mb-0">
                                        {{ _("Groups") }}
                                    </h3>
                                </div>
                                <div class="col text-right">
                                    <a id="create-group-modal" data-toggle="modal" data-target="#modal-put-group" class="btn btn-sm btn-primary">
                                        <span class="btn-inner--text" style="color: white;">{{ _("Create group") }}</span>
                                    </a>
                                </div>
                                <div class="modal fade" id="modal-put-group" tabindex="-1" role="dialog" aria-labelledby="modal-put-group" aria-hidden="true">
                                    <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="modal-title-default">{{ _("Create group") }}</h4>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                                </button>
                                            </div>
                                            <form method="post">{% csrf_token %}
                                                <input name="cmd" value="put_group" hidden>
                                                <div class="modal-body">
                                                    <div class="pl-lg-12">
                                                        <div class="row">
                                                            <div class="col-lg-12">
                                                                <div class="form-group">
                                                                    <label class="form-control-label" for="input-username">{{ _("Name") }}</label>
                                                                    <input id="group-name" name="group_name" type="text" id="input-username" class="form-control form-control-alternative" placeholder="{{ _("Group name") }}">
                                                                </div>
                                                                <div class="form-group">
                                                                    <label class="form-control-label" for="input-username">{{ _("Description") }}</label>
                                                                    <input id="group-description" name="group_description" type="text" id="input-username" class="form-control form-control-alternative" placeholder="{{ _("Group description") }}">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p>
                                                        {{ _("Click the confirm button to create the group") }}
                                                    </p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                    <button id="create-group" type="submit" class="btn btn-primary">{{ _("Confirm") }}</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="table-responsive">
                            <!-- Projects table -->
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                <tr>
                                    <th scope="col">{{ _("Name") }}</th>
                                    <th scope="col">{{ _("Description") }}</th>
                                    <th scope="col">{{ _("Permissions") }}</th>
                                    <th scope="col"></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for group in user_groups %}
                                    <tr>
                                        <th name="group-name" scope="row">
                                            {{ group.name }}
                                        </th>
                                        <td name="group-description">
                                            {{ group.description }}
                                        </td>
                                        <td name="group-description">
                                            <button id="modify-permissions-{{ group.name }}" data-toggle="modal"  data-target="#modal-permissions-{{ group.name }}" class="btn btn-sm btn-info"> {{ _("Manage") }} ({{ group.permissions|length }}) </button>

                                            <div class="modal fade" id="modal-permissions-{{ group.name }}" tabindex="-1" role="dialog" aria-labelledby="modal-permissions-{{ group.name }}" aria-hidden="true">
                                                <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h4 class="modal-title" id="modal-title-default">{{ _("Manage group permissions") }}</h4>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">×</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="pl-lg-12">

                                                                <div class="form-group">
                                                                    <label class="form-control-label">{{ _("Add permissions") }}</label>
                                                                    <div class="row">
                                                                        <div class="col-9">
                                                                            <select id="select-permissions-{{ group.name }}" class="form-control">
                                                                                {% for permission in all_permissions %}
                                                                                    {% if permission not in group.permissions %}
                                                                                        <option value="{{ permission }}">
                                                                                            {{ permission }}
                                                                                        </option>
                                                                                    {% endif %}
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                        <div class="col-3">
                                                                            <button class="form-control btn btn-success" onclick="attach_group_permission('{{ group.name }}')">+</button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label class="form-control-label">{{ _("Permissions") }}</label>
                                                                    <div class="row">
                                                                        <div class="col-12">

                                                                            <div class="form-group">
                                                                                <div class="table-responsive">
                                                                                    <table class="table align-items-center table-hover table-flush">
                                                                                        <thead class="thead-light">
                                                                                        <tr>
                                                                                            <th scope="col">{{ _("Permission name") }}</th>
                                                                                            <th scope="col"></th>
                                                                                        </tr>
                                                                                        </thead>
                                                                                        <tbody id="permissions-{{ group }}" style="background: white;">
                                                                                        {% for permission in group.permissions %}
                                                                                            <tr>
                                                                                                <td>{{ permission }}</td>
                                                                                                <td>
                                                                                                    <a class="btn btn-danger btn-sm text text-white" style="padding-top:0; padding-bottom:0;" onclick="detach_group_permission('{{ group.name }}', '{{ permission }}');"><i class="fas fa-trash"></i></a>
                                                                                                </td>
                                                                                            </tr>
                                                                                        {% endfor %}
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button data-dismiss="modal" type="submit" class="btn btn-primary">{{ _("Confirm") }}</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="col text-right">
                                                <form role="form" method="post">{% csrf_token %}
                                                    <input name="cmd" value="delete_group" hidden>
                                                    <input name="group_name" value="{{ group.name }}" hidden>
                                                    <button id="remove-group-{{ group.name }}" type="submit" class="btn btn-sm btn-danger">{{ _("Remove") }}</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-xl-12 mb-5 mb-xl-0">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h3 class="mb-0">
                                        {{ _("Sign-in methods") }}
                                    </h3>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <!-- Projects table -->
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                <tr>
                                    <th scope="col">{{ _("Method") }}</th>
                                    <th scope="col">{{ _("Description") }}</th>
                                    <th scope="col">{{ _("Default group when joining") }}</th>
                                    <th scope="col">{{ _("Policy") }} <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="top" title="If the return value of the Python3 function is True, membership is allowed"></i></th>
                                    <th scope="col">{{ _("Enabled") }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <th scope="row">
                                        {{ _("Email/Password login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.login</a>
                                    </td>

                                    <td>
                                        <select id="email_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == email_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info text-white" data-toggle="modal" data-target="#modal-email-register-policy">{{ _("Manage policy") }}</a>
                                        <div class="modal fade" id="modal-email-register-policy" tabindex="-1" role="dialog" aria-labelledby="modal-email-register-policy" aria-hidden="true">
                                            <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="modal-title-default">{{ _("Manage policy") }}</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">×</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="pl-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <div style="height: 250px;">
                                                                        <!-- CODE EDITOR -->
                                                                        <style type="text/css" media="screen">
                                                                            #email-register-policy-code {
                                                                                margin: 0;
                                                                                margin-top: 0px;
                                                                                position: absolute;
                                                                                top: 0;
                                                                                bottom: 10px;
                                                                                left: 0;
                                                                                right: 0;
                                                                            }
                                                                        </style>
                                                                        <pre id="email-register-policy-code">{{ email_login.register_policy_code }}</pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                        <button id="save-email-register-policy-btn" class="btn btn-primary" onclick="set_email_login();">{{ _("Save") }}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <label class="custom-toggle">
                                            {% if email_login.enabled %}
                                                <input id="email_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="email_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>

                                <tr>
                                    <th scope="row">
                                        {{ _("Facebook login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.login_facebook</a>
                                    </td>
                                    <td>
                                        <select id="facebook_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == facebook_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info text-white" data-toggle="modal" data-target="#modal-facebook-register-policy">{{ _("Manage policy") }}</a>
                                        <div class="modal fade" id="modal-facebook-register-policy" tabindex="-1" role="dialog" aria-labelledby="modal-facebook-register-policy" aria-hidden="true">
                                            <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="modal-title-default">{{ _("Manage policy") }}</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">×</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="pl-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <div style="height: 250px;">
                                                                        <!-- CODE EDITOR -->
                                                                        <style type="text/css" media="screen">
                                                                            #facebook-register-policy-code {
                                                                                margin: 0;
                                                                                margin-top: 0px;
                                                                                position: absolute;
                                                                                top: 0;
                                                                                bottom: 10px;
                                                                                left: 0;
                                                                                right: 0;
                                                                            }
                                                                        </style>
                                                                        <pre id="facebook-register-policy-code">{{ facebook_login.register_policy_code }}</pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                        <button id="save-facebook-register-policy-btn" class="btn btn-primary" onclick="set_facebook_login();">{{ _("Save") }}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <label class="custom-toggle">
                                            {% if facebook_login.enabled %}
                                                <input id="facebook_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="facebook_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>

                                <tr>
                                    <th scope="row">
                                        {{ _("Google login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.login_google</a>
                                    </td>
                                    <td>
                                        <select id="google_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == google_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info text-white" data-toggle="modal" data-target="#modal-google-register-policy">{{ _("Manage policy") }}</a>
                                        <div class="modal fade" id="modal-google-register-policy" tabindex="-1" role="dialog" aria-labelledby="modal-google-register-policy" aria-hidden="true">
                                            <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="modal-title-default">{{ _("Manage policy") }}</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">×</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="pl-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <div style="height: 250px;">
                                                                        <!-- CODE EDITOR -->
                                                                        <style type="text/css" media="screen">
                                                                            #google-register-policy-code {
                                                                                margin: 0;
                                                                                margin-top: 0px;
                                                                                position: absolute;
                                                                                top: 0;
                                                                                bottom: 10px;
                                                                                left: 0;
                                                                                right: 0;
                                                                            }
                                                                        </style>
                                                                        <pre id="google-register-policy-code">{{ google_login.register_policy_code }}</pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                        <button id="save-google-register-policy-btn" class="btn btn-primary" onclick="set_google_login();">{{ _("Save") }}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <label class="custom-toggle">
                                            {% if google_login.enabled %}
                                                <input id="google_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="google_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>


                                <tr>
                                    <th scope="row">
                                        {{ _("Naver login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.login_naver</a>
                                    </td>
                                    <td>
                                        <select id="naver_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == naver_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info text-white" data-toggle="modal" data-target="#modal-naver-register-policy">{{ _("Manage policy") }}</a>
                                        <div class="modal fade" id="modal-naver-register-policy" tabindex="-1" role="dialog" aria-labelledby="modal-naver-register-policy" aria-hidden="true">
                                            <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="modal-title-default">{{ _("Manage policy") }}</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">×</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="pl-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <div style="height: 250px;">
                                                                        <!-- CODE EDITOR -->
                                                                        <style type="text/css" media="screen">
                                                                            #naver-register-policy-code {
                                                                                margin: 0;
                                                                                margin-top: 0px;
                                                                                position: absolute;
                                                                                top: 0;
                                                                                bottom: 10px;
                                                                                left: 0;
                                                                                right: 0;
                                                                            }
                                                                        </style>
                                                                        <pre id="naver-register-policy-code">{{ naver_login.register_policy_code }}</pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                        <button id="save-naver-register-policy-btn" class="btn btn-primary" onclick="set_naver_login();">{{ _("Save") }}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <label class="custom-toggle">
                                            {% if naver_login.enabled %}
                                                <input id="naver_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="naver_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <th scope="row">
                                        {{ _("Kakao login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.login_kakao</a>
                                    </td>
                                    <td>
                                        <select id="kakao_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == kakao_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <a class="btn btn-sm btn-info text-white" data-toggle="modal" data-target="#modal-kakao-register-policy">{{ _("Manage policy") }}</a>
                                        <div class="modal fade" id="modal-kakao-register-policy" tabindex="-1" role="dialog" aria-labelledby="modal-kakao-register-policy" aria-hidden="true">
                                            <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title" id="modal-title-default">{{ _("Manage policy") }}</h4>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">×</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="pl-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-12">
                                                                    <div style="height: 250px;">
                                                                        <!-- CODE EDITOR -->
                                                                        <style type="text/css" media="screen">
                                                                            #kakao-register-policy-code {
                                                                                margin: 0;
                                                                                margin-top: 0px;
                                                                                position: absolute;
                                                                                top: 0;
                                                                                bottom: 10px;
                                                                                left: 0;
                                                                                right: 0;
                                                                            }
                                                                        </style>
                                                                        <pre id="kakao-register-policy-code">{{ kakao_login.register_policy_code }}</pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                        <button id="save-kakao-register-policy-btn" class="btn btn-primary" onclick="set_kakao_login();">{{ _("Save") }}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <label class="custom-toggle">
                                            {% if kakao_login.enabled %}
                                                <input id="kakao_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="kakao_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>


                                <tr>
                                    <th scope="row">
                                        {{ _("Guest login") }}
                                    </th>
                                    <td>
                                        <a href="#">cloud.auth.guest</a>
                                    </td>

                                    <td>
                                        <select id="guest_default_group" class="form-control">
                                            {% for group in user_groups %}
                                                {% if group.name == guest_login.default_group_name %}
                                                    <option value="{{ group.name }}" selected>{{ group.name }}</option>
                                                {% else %}
                                                    <option value="{{ group.name }}">{{ group.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </td>

                                    <td>

                                    </td>
                                    <td>
                                        <label class="custom-toggle">
                                            {% if guest_login.enabled %}
                                                <input id="guest_enabled" type="checkbox" checked>
                                            {% else %}
                                                <input id="guest_enabled" type="checkbox">
                                            {% endif %}
                                            <span class="custom-toggle-slider rounded-circle"></span>
                                        </label>
                                    </td>
                                </tr>


                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        <div class="modal fade" id="modal-query-user" tabindex="-1" role="dialog" aria-labelledby="modal-query-user" aria-hidden="true">
                                                    <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h4 class="modal-title" id="modal-title-default">{{ _("Search items") }}</h4>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">×</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="pl-lg-12">
                                                                    <div class="row">
                                                                        <div class="col-lg-12">
                                                                            <div class="form-group">
                                                                                <label class="form-control-label">{{ _("Add query") }}</label>

                                                                                <div class="row">
                                                                                    <div class="col-4">
                                                                                        <input id="query-field-name" class="form-control form-control-alternative" type="text" placeholder="{{ _("Field name") }}"/>
                                                                                    </div>
                                                                                    <div class="col-4">
                                                                                        <select id="query-operation" class="form-control">
                                                                                            <option value="eq">==</option>
                                                                                            <option value="neq">!=</option>
                                                                                            <option value="in">contains</option>
                                                                                            <option value="nin">not contains</option>
                                                                                            <option value="gt"> > </option>
                                                                                            <option value="ls"> < </option>
                                                                                            <option value="ge"> >= </option>
                                                                                            <option value="le"> <= </option>
                                                                                        </select>
                                                                                    </div>
                                                                                    <div class="col-4">
                                                                                        <input id="query-field-value" class="form-control form-control-alternative" type="text" placeholder="{{ _("Field value") }}"/>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="row mt-3">
                                                                                    <div class="col-6">
                                                                                        <select id="logic-operation" class="form-control" disabled>
                                                                                            <option value="or">OR</option>
                                                                                            <option value="and">AND</option>
                                                                                        </select>
                                                                                    </div>
                                                                                    <div class="col-6">
                                                                                        <input onclick="put_query();" type="button" class="form-control btn btn-success" value="+">
                                                                                    </div>

                                                                                </div>

                                                                            </div>

                                                                            <div class="form-group">
                                                                                <label class="form-control-label">{{ _("Query") }}</label>
                                                                                <div class="table-responsive">
                                                                                    <table id="query-list" class="table table-sm table-hover scroll-content">
                                                                                        <thead class="thead-light">
                                                                                        <tr>
                                                                                            <th>
                                                                                                {{ _("option") }}
                                                                                            </th>
                                                                                            <th>
                                                                                                {{ _("field") }}
                                                                                            </th>
                                                                                            <th>
                                                                                                {{ _("condition") }}
                                                                                            </th>
                                                                                            <th>
                                                                                                {{ _("value") }}
                                                                                            </th>
                                                                                            <th>

                                                                                            </th>
                                                                                        </tr>
                                                                                        </thead>
                                                                                        <tbody style="background: white;">

                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="form-control-label">{{ _("Generated Query") }}</label>
                                                                                <textarea id="query-text" class="form-control form-control-alternative" disabled></textarea>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                                <button id="query-item-btn" class="btn btn-primary">{{ _("Search") }}</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

            <div class="row mt-4">
                <div class="col-xl-12">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h3 class="mb-0">
                                        {{ _("Members") }}
                                    </h3>
                                </div>

                                <div class="col text-right">
                                    <a id="search-user-button" data-toggle="modal" data-target="#modal-query-user" class="btn btn-sm">
                                        <span class="btn-inner--text" style="color: black;">{{ _("Search") }}</span>
                                    </a>
                                    <a id="create-user-button" data-toggle="modal" data-target="#modal-put-user" class="btn btn-sm btn-primary">
                                        <span class="btn-inner--text" style="color: white;">{{ _("Create member") }}</span>
                                    </a>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-icon-only text-light" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                            <a class="dropdown-item" onclick="delete_checked_users();"><i class="fas fa-trash"></i> {{ _("Delete selected") }}</a>
                                            <a class="dropdown-item" data-toggle="modal" data-target="#modal-mod-user"><i class="fas fa-user-edit"></i>{{ _("Edit selected") }}</a>
                                        </div>
                                    </div>
                                </div>


                                <div class="modal fade" id="modal-put-user" tabindex="-1" role="dialog" aria-labelledby="modal-put-user" aria-hidden="true">
                                    <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="modal-title-default">{{ _("Create member") }}</h4>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                                </button>
                                            </div>
                                            <form method="post">{% csrf_token %}
                                                <input name="cmd" value="put_user" hidden>
                                                <div class="modal-body">
                                                    <div class="pl-lg-12">
                                                        <div class="row">
                                                            <div class="col-lg-12">

                                                                <div class="form-group">
                                                                    <label class="form-control-label" for="input-username">{{ _("Email") }}</label>
                                                                    <input name="user_email" type="email" id="input-username" class="form-control form-control-alternative" placeholder="example@email.com">
                                                                </div>
                                                                <div class="form-group">
                                                                    <label class="form-control-label" for="input-password">{{ _("Password") }}</label>
                                                                    <input name="user_password" type="password" id="input-password" class="form-control form-control-alternative" placeholder="******">
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p>
                                                        {{ _("Click confirm button to create the member") }}
                                                    </p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                    <button id="create-user-commit" type="submit" class="btn btn-primary">{{ _("Confirm") }}</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>


                                <div class="modal fade" id="modal-mod-user" tabindex="-1" role="dialog" aria-labelledby="modal-mod-user" aria-hidden="true">
                                    <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h4 class="modal-title" id="modal-title-default">{{ _("Edit member") }}</h4>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="pl-lg-12">
                                                    <div class="row">
                                                        <div class="col-lg-12">

                                                            <div class="form-group">
                                                                <label class="form-control-label" for="user-field-name">{{ _("Field name to modify") }}</label>
                                                                <input name="user-field-name" type="text" id="user-field-name" class="form-control form-control-alternative" placeholder="Field name">
                                                            </div>

                                                            <div class="form-group">
                                                                <label class="form-control-label" for="field-type">{{ _("Field type to modify") }}</label>
                                                                <select id="user-field-type" class="form-control">
                                                                    <option value="S">{{ _("String") }}</option>
                                                                    <option value="N">{{ _("Number") }}</option>
                                                                </select>
                                                            </div>

                                                            <div class="form-group">
                                                                <label class="form-control-label" for="user-field-value">{{ _("Field value to modify") }}</label>
                                                                <input name="user-field-value" type="text" id="user-field-value" class="form-control form-control-alternative" placeholder="Field value">
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                                <p>
                                                    {{ _("Click confirm button to modify the member information") }}
                                                </p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-link  ml-auto" data-dismiss="modal">{{ _("Cancel") }}</button>
                                                <button id="mod-user-commit" class="btn btn-primary" onclick="set_checked_users();">{{ _("Confirm") }}</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                        <div id="user-table" class="table-responsive">
                            <!-- Projects table -->
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                <tr>
                                    {% for visible_user_field in visible_user_fields %}
                                        <th scope="col">{{ visible_user_field }}</th>
                                    {% endfor %}
                                    <th scope="col">login_method</th>
                                    <th scope="col">+ Extra</th>
                                    <th scope="col"></th>
                                </tr>
                                </thead>
                                <tbody style="max-height: 400px; overflow-y: auto;">

                                </tbody>
                            </table>
                        </div>
                        <button id="load-more-users-btn" class="btn-primary btn-block rounded-bottom" onclick="load_more_users();">
                            {{ _("More items") }} +
                        </button>
                    </div>
                </div>
            </div>


            <div class="row mt-4">
                <div class="col-xl-12">
                    <div class="card shadow">
                        <div class="card-header border-0">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h3 class="mb-0">
                                        {{ _("Sessions") }}
                                    </h3>
                                </div>

                                <div class="col text-right">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-icon-only text-light" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                            <a class="dropdown-item" onclick="delete_checked_sessions();"><i class="fas fa-trash"></i>{{ _("Delete selected") }}</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="session-table" class="table-responsive">
                            <!-- Projects table -->
                            <table class="table align-items-center table-flush">
                                <thead class="thead-light">
                                <tr>
                                    <th scope="col">user_id</th>
                                    <th scope="col">createDate</th>
                                    <th scope="col">sessionType</th>
                                    <th scope="col">session_id (HASH)</th>
                                    <th scope="col">
                                        <div class="custom-control custom-checkbox mt--4">
                                            <input class="custom-control-input" type="checkbox" name="checkbox-session" id="check-all-sessions">
                                            <label class="custom-control-label" for="check-all-sessions"></label>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>

                        </div>
                        <button id="load-more-sessions-btn" class="btn-primary btn-block rounded-bottom" onclick="load_more_sessions();">
                            {{ _("More items") }} +
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="row align-items-center justify-content-xl-between">
                    <div class="col-xl-6">
                        <div class="copyright text-center text-xl-left text-muted">
                            &copy; 2018 <a href="https://aws-interface.com" class="font-weight-bold ml-1" target="_blank">AWS Interface</a>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="{% static 'ace/src-noconflict/ace.js' %}" type="text/javascript" charset="utf-8"></script>
    <script>
        const email_policy_code_editor = ace.edit("email-register-policy-code");
        email_policy_code_editor.session.setMode("ace/mode/python");

        const facebook_policy_code_editor = ace.edit("facebook-register-policy-code");
        facebook_policy_code_editor.session.setMode("ace/mode/python");

         const google_policy_code_editor = ace.edit("google-register-policy-code");
         google_policy_code_editor.session.setMode("ace/mode/python");

         const naver_policy_code_editor = ace.edit("naver-register-policy-code");
         naver_policy_code_editor.session.setMode("ace/mode/python");

         const kakao_policy_code_editor = ace.edit("kakao-register-policy-code");
         kakao_policy_code_editor.session.setMode("ace/mode/python");

    </script>
    <script>
        var query_instructions = [];

        var sessions_end_key = null;
        var users_end_key = null;

        function set_email_login(){
            var email_default_group = $("#email_default_group").val();
            var email_enabled = $("#email_enabled").is(':checked');
            var register_policy_code = email_policy_code_editor.getValue();
            $.post("", {
                cmd: "set_login_method",
                login_method: 'email_login',
                default_group_name: email_default_group,
                enabled: email_enabled,
                register_policy_code: register_policy_code,
            }, function (data) {

            });
            $("#modal-email-register-policy").modal('hide');
        }
        function set_facebook_login(){
            var facebook_default_group = $("#facebook_default_group").val();
            var facebook_enabled = $("#facebook_enabled").is(':checked');
            var register_policy_code = facebook_policy_code_editor.getValue();
            $.post("", {
                cmd: "set_login_method",
                login_method: 'facebook_login',
                default_group_name: facebook_default_group,
                enabled: facebook_enabled,
                register_policy_code: register_policy_code,
            }, function (data) {

            });
            $("#modal-facebook-register-policy").modal('hide');
        }
        
        function set_google_login(){
            var google_default_group = $("#google_default_group").val();
            var google_enabled = $("#google_enabled").is(':checked');
            var register_policy_code = google_policy_code_editor.getValue();
            $.post("", {
                cmd: "set_login_method",
                login_method: 'google_login',
                default_group_name: google_default_group,
                enabled: google_enabled,
                register_policy_code: register_policy_code,
            }, function (data) {

            });
            $("#modal-google-register-policy").modal('hide');
        }
        
        function set_naver_login(){
            var naver_default_group = $("#naver_default_group").val();
            var naver_enabled = $("#naver_enabled").is(':checked');
            var register_policy_code = naver_policy_code_editor.getValue();
            $.post("", {
                cmd: "set_login_method",
                login_method: 'naver_login',
                default_group_name: naver_default_group,
                enabled: naver_enabled,
                register_policy_code: register_policy_code,
            }, function (data) {

            });
            $("#modal-naver-register-policy").modal('hide');
        }
        
        function set_kakao_login(){
            var kakao_default_group = $("#kakao_default_group").val();
            var kakao_enabled = $("#kakao_enabled").is(':checked');
            var register_policy_code = kakao_policy_code_editor.getValue();
            $.post("", {
                cmd: "set_login_method",
                login_method: 'kakao_login',
                default_group_name: kakao_default_group,
                enabled: kakao_enabled,
                register_policy_code: register_policy_code,
            }, function (data) {

            });
            $("#modal-kakao-register-policy").modal('hide');
        }
        function set_guest_login(){
            var guest_default_group = $("#guest_default_group").val();
            var guest_enabled = $("#guest_enabled").is(':checked');

            $.post("", {
                cmd: "set_login_method",
                login_method: 'guest_login',
                default_group_name: guest_default_group,
                enabled: guest_enabled,
            }, function (data) {

            });
        }
        function delete_sessions(session_ids){
            $.LoadingOverlay('show', {
                text:'{{ _("Deleting sessions..") }}'
            });
            $.post("", {
                cmd: "delete_sessions",
                'session_ids[]': session_ids,
            }, function (data) {
                $.LoadingOverlay('hide');
                window.location.reload();
            });
        }
        function delete_users(user_ids){
            $.LoadingOverlay('show', {
                text:'{{ _("Deleting users..") }}'
            });
            $.post("", {
                cmd: "delete_users",
                'user_ids[]': user_ids,
            }, function (data) {
                window.location.reload();
                $.LoadingOverlay('hide');
            });
        }

        function set_users(user_ids) {
            const field_name = $("#user-field-name").val();
            const field_type = $("#user-field-type").val();
            const field_value = $("#user-field-value").val();
            if (field_type == 'N' && !$.isNumeric(field_value)){
                alert("{{ _("Numeric types can only contain numeric variables") }}");
                return;
            }
            $.LoadingOverlay('show', {
                text:'{{ _("Modifying users..") }}'
            });
            $.post("", {
                cmd: "set_users",
                'user_ids[]': user_ids,
                'field_name': field_name,
                'field_type': field_type,
                'field_value': field_value,
            }, function (data) {
                window.location.reload();
                $.LoadingOverlay('hide');
            });
        }

        function delete_checked_sessions(){
            var session_ids = [];
            var checkboxs = $("input[name='checkbox-session']");
            for (var i = 0; i < checkboxs.length; i++){
                if (checkboxs[i].checked){
                    session_ids.push(checkboxs[i].id);
                }
            }
            delete_sessions(session_ids);
        }

        function delete_checked_users(){
            var user_ids = [];
            var checkboxs = $("input[name='checkbox-user']");
            for (var i = 0; i < checkboxs.length; i++){
                if (checkboxs[i].checked){
                    user_ids.push(checkboxs[i].id);
                }
            }
            delete_users(user_ids);
        }

        function set_checked_users() {
            var user_ids = [];
            var checkboxs = $("input[name='checkbox-user']");
            for (var i = 0; i < checkboxs.length; i++){
                if (checkboxs[i].checked){
                    user_ids.push(checkboxs[i].id);
                }
            }
            set_users(user_ids);
        }

        function detach_group_permission(group_name, permission){
            $.post("", {
                cmd: "detach_group_permission",
                group_name: group_name,
                permission: permission,
            }, function (data) {
                window.location.reload();
            });
        }

        function detach_user_group(user_id, group_name) {
            if (confirm('{{ _("Are you sure you want to delete this group?") }}')){
                $.post("", {
                    cmd: "detach_user_group",
                    group_name: group_name,
                    user_id: user_id,
                }, function (data) {
                    window.location.reload();
                });
            }

        }

        function attach_group_permission(group_name){
            const permission = $("#select-permissions-" + group_name).val();
            $.post("", {
                cmd: "attach_group_permission",
                group_name: group_name,
                permission: permission,
            }, function (data) {
                window.location.reload();
            });
        }

        function load_more_sessions(){
            var item = {
                cmd: 'get_session_rows',
            };

            if (sessions_end_key != null){
                item['start_key'] = sessions_end_key;
            }
            $.post("", item, function (data) {
                const session_rows = data['session_rows'];
                sessions_end_key = data['end_key'];
                if (sessions_end_key == null){
                    $("#load-more-sessions-btn").hide();
                }
                $("#session-table>table").append(session_rows);
            });
        }

        function clear_users() {
            $("#user-table>table").empty();
        }

        function load_more_users(){
            var self = this;
            var item = {
                cmd: 'get_user_rows',
                'query[]': query_instructions,
            };

            if (this.users_end_key){
                item['start_key'] = JSON.stringify(this.users_end_key);
            }
            $.post("", item, function (data) {
                const user_rows = data['user_rows'];
                self.users_end_key = data['end_key'];
                if (self.users_end_key == null){
                    $("#load-more-users-btn").hide();
                }
                $("#user-table>table").append(user_rows);
            });
        }


        function query_items(instructions) {
            query_instructions = instructions;
            clear_users();
            load_more_users();
        }

        window.onload = function(){
            $("#email_default_group").change(function () {
                set_email_login()
            });
            $("#email_enabled").change(function () {
                set_email_login()
            });
            $("#guest_default_group").change(function () {
                set_guest_login()
            });
            $("#guest_enabled").change(function () {
                set_guest_login()
            });
            $("#facebook_default_group").change(function () {
                set_facebook_login()
            });
            $("#facebook_enabled").change(function () {
                set_facebook_login()
            });

            $("#check-all-sessions").click(function () {
                $("input[name='checkbox-session']").prop('checked', this.checked);
            });
            $("#check-all-users").click(function () {
                $("input[name='checkbox-user']").prop('checked', this.checked);
            });

            $("#query-item-btn").click(function () {
                var query_json_instructions = [];
                for (var i = 0; i < query_instructions.length; i++){
                    query_json_instructions.push(query_instructions[i]);
                }
                query_items(query_json_instructions);
            });

            $(document).ready(function () {
                load_more_users();
                load_more_sessions();
            });
        }

        function render_query_list() {
            $("#query-list>tbody").empty();
            if (query_instructions.length > 0){
                $("#logic-operation").prop("disabled", false);
            }else{
                $("#logic-operation").prop("disabled", true);
                $("#logic-operation").val('or');
            }
            $("#query-text").val(query_instructions);
            for (var i = 0; i < query_instructions.length; i++){
                var query = query_instructions[i];
                query = JSON.parse(query);
                if (i == 0){
                    query['option'] = '';
                }
                var tag = "" +
                    "<tr>\n" +
                    "<td>\n" +
                    query['option'] +
                    "</td>\n" +
                    "<td>\n" +
                    query['field'] +
                    "</td>\n" +
                    "<td>\n" +
                    query['condition'] +
                    "</td>\n" +
                    "<td>\n" +
                    query['value'] +
                    "</td>\n" +
                    "<td>\n" +
                    "<a class=\"btn btn-danger btn-sm text text-white\" style=\"padding-top:0; padding-bottom:0;\" onclick=\"remove_query(" + i + ");\"><i class=\"fas fa-trash\"></i></a>" +
                    "</td>\n" +
                    "</tr>";
                $("#query-list").append(tag);
            }
        }

        function make_query(logic_operation, field_name, query_operation, field_value) {
            _query = {
                'option': logic_operation,
                'field': field_name,
                'condition': query_operation,
                'value': field_value,
            };
            _query = String(JSON.stringify(_query));
            return _query;
        }
        function put_query() {
            var logic_operation = $("#logic-operation").val();
            var field_name = $("#query-field-name").val();
            var query_operation = $("#query-operation").val();
            var field_value = $("#query-field-value").val();
            var query = make_query(logic_operation, field_name, query_operation, field_value);
            query_instructions.push(query);
            render_query_list();
        }

        function remove_query(_query_idx) {
            query_instructions.splice(_query_idx, 1);
            render_query_list();
        }


    </script>

{% endblock %}